---
title: "Multivariate analysis"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})

author: "Carlos"
date: "02/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Multivariate Analysis of Network data

Note: This tutorial is bascially the same as the on described in "Protocol_multivariate.R". Either download the repo or, much easier, just copy the script and paste into your r script.

## Intro & Basics

The question addressed here is whether network traits "cluster" according to species identity
For this we are using:

  * PCA: To visualize whether there is any clustering
  * Difference in the correlations among variables per species
  * PERMANOVA: to test difference among groups

To do that I use base R functions combined with functions from three other packages: vegan, tidyverse and RColorBrewer
You might need to install those packages. You can do that via R studio or: 

```{r, echo=FALSE}
#install.packages("vegan")
#install.packages("tidyverse")
#install.packages("RColorBrewer")

#Comment in if needed!
library(vegan)
library(tidyverse)
```

## 1. Loading files.

Note: one can load directly excel files (.xlxs) using R studio. This is a relatively new
feature. I am used to the function "read.csv" for which I need to save the excel sheet I am interested as
a csv file first. In this case, I saved the "edge" sheet of each excel file of each of the 6 species as .csv

# First Edge files

```{r }
#These lines will load all files saved as .csv in the folder "processedData" and then merging them ("row bind")
temp = list.files(path="processedData\\",pattern="*-Edge.csv")
temp<-paste("processedData\\",temp,sep = "")
myfiles = lapply(temp,function(x){read.csv(x,header = TRUE,stringsAsFactors = FALSE)} )
#myfiles[[4]]<-myfiles[[4]][,c(1:42)]
Edge_Traits<-do.call(rbind,myfiles)

Edge_Traits$Species<-NA
Edge_Traits$Species[grep("C34",Edge_Traits$name)]<-"Mortierella elongata"
Edge_Traits$Species[grep("C35",Edge_Traits$name)]<-"Umbelopsis isabellina"
Edge_Traits$Species[grep("DF19",Edge_Traits$name)]<-"Mortierella alpina"
Edge_Traits$Species[grep("DF25",Edge_Traits$name)]<-"Mortierella elongata2"
Edge_Traits$Species[grep("DF56",Edge_Traits$name)]<-"Mucor fragilis"
Edge_Traits$Species[grep("M",Edge_Traits$name)]<-"Mortierella alpina2"

#Assuming the Or_ij can be expressed from 0 to 360 degrees
Edge_Traits$Or_ij[which(Edge_Traits$Or_ij<0)]<-(Edge_Traits$Or_ij[which(Edge_Traits$Or_ij<0)]*-1)+180

Edge_Traits<-Edge_Traits[which(Edge_Traits$Type=="E"),]

#I am removing seven values with Width=0
Edge_Traits<-Edge_Traits[-which(Edge_Traits$Width==0),]

```

# Adding nodes
```{r}
temp = list.files(path="processedData\\",pattern="*-Node.csv")
temp<-paste("processedData\\",temp,sep = "")
myfiles = lapply(temp,function(x){read.csv(x,header = TRUE,stringsAsFactors = FALSE,sep = ";")} )
#myfiles[[4]]<-myfiles[[4]][,c(1:42)]
Node_Traits<-do.call(rbind,myfiles)

Node_Traits$node_name_ID<-paste(Node_Traits$name,Node_Traits$node_ID,sep = "_")

#Edge_Traits_o<-Edge_Traits
```

#Merging them
```{r}

#For the first node
trial<-
left_join(Edge_Traits%>%
            mutate(node_name_ID=paste(name,EndNodes_1,sep = "_")),
          Node_Traits[,c("node_name_ID","node_Type","node_Degree")])

trial<-trial%>%
  rename(node_1_name_ID=node_name_ID)%>%
  rename(EndNodes_1_Type=node_Type)%>%
  rename(EndNodes_1_Degree=node_Degree)


#For the second node
trial<-
left_join(trial%>%
            mutate(node_name_ID=paste(name,EndNodes_2,sep = "_")),
          Node_Traits[,c("node_name_ID","node_Type","node_Degree")])

trial<-trial%>%
  rename(node_2_name_ID=node_name_ID)%>%
  rename(EndNodes_2_Type=node_Type)%>%
  rename(EndNodes_2_Degree=node_Degree)

Edge_Traits_o<-Edge_Traits
Edge_Traits<-trial;rm(trial)
```


## 2. Getting to know the data.

### 2.1 How R sees the data. 
It is useful to have an idea on how R recognize the data. R is an "object oriented"
program language. That is, every data is an object which has certain properties. R uses these properties to 
categorized the object. It is useful to know what kind of object is your data because some functions only work
on one object type but not in others.


```{r}
str(Edge_Traits)
```

### 2.2. Understanding the variables and their distribution. 

More impotantly, what is the distribution of the data? 
To simply get means, min, max per fungal species per variable:
```{r}
aggregate(
        Edge_Traits[,
                         c("Width","Length","Area","Volume","Resistance_2ave","Tortuosity","Distance",
                           "Accessibility","Betweenness","Route_factor","Or_ij")],
        by=list(Edge_Traits[which(Edge_Traits$Type=="E"),]$name),
        mean)#Here you  can write different functions: min, max, median. range and summmary is also good because it
                #gets you more than one summary statistics, but it can be confusing with so much data.
```


I had some issues understanding what Resistance is. Playing with the following code allowed me to determine that 
 Resistance_2ave = 10*(Length)/width^2
```{r,eval=FALSE}
summary(Edge_Traits$Resistance_2ave)
length(which(Edge_Traits$Width_intact==0))
Edge_Traits%>%
        #filter(Area!=0)%>%
        #filter(Resistance_2ave>500)%>%
        mutate(MyResistance=Length/(Width/2)^2)%>%
        mutate(Factor=Resistance_2ave/MyResistance)%>%
        select(Species,name,Length,Width,Resistance_2ave)%>%
        ggplot()+
        aes(y=Resistance_2ave,x=name,fill=name)+
        geom_boxplot()+
        facet_grid(. ~ Species, scales = "free")+
        theme(legend.position = "none")
  

length(which(Edge_Traits$Resistance_2ave>500))
```


```{r,echo=FALSE}
#First, reorganizing the dataframe helps so the figures are made easier

Re_org<-
        Edge_Traits%>%
        #filter(Area!=0)%>%
        #mutate(MyResistance=Length/(Width/2)^2)%>%
        select(c("name","Species",
                 "Width","Length","Area","Volume","Resistance_2ave","Tortuosity","Distance",
                 "Accessibility","Betweenness","Route_factor","Or_ij"))%>%
        group_by(name)%>%
        gather(key=variable,
               value=value,Width:Or_ij)
names(Edge_Traits)
```        
        


```{r,echo = FALSE,message=FALSE}
Hist_Width_Length_Distance_1<-
        Re_org%>%
        filter(variable %in% c("Width","Length","Distance"))%>%#1_The completely indepedent variables
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 3)+
        theme(legend.position = "none")
  
Hist_Width_Length_Area_Vol_2<-
          Re_org%>%
        
        filter(variable %in% c("Width","Length","Area","Volume"))%>%#2_The geometric ones depending on width and length
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 4)+
        theme(legend.position = "none")

Hist_Width_Length_Resistance_3<-
          Re_org%>%
        
        filter(variable %in% c("Width","Length","Resistance_2ave"))%>%#3_The "transport" one depending on width and length
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 3)+
        theme(legend.position = "none")

#Hist_Length_Tortuosity_4<-For this one see below

Hist_Resistance_Accessibility_Betweenness_5<-
          Re_org%>%
        
        filter(variable %in% c("Resistance_2ave","Accessibility","Betweenness"))%>%#5_The "transport" ones depending all on Resistance to some extent
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 3)+
        theme(legend.position = "none")

Hist_Distance_Route_factor_6<-
        
        Re_org%>%
        
        filter(variable %in% c("Route_factor","Distance"))%>%#6_The only that depends on distance
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 2)+
        theme(legend.position = "none")
```

About tortuosity

```{r,echo = TRUE,message=FALSE,eval=FALSE}
tapply(Edge_Traits$Tortuosity,Edge_Traits$name,summary)
tapply(Edge_Traits$Tortuosity,Edge_Traits$name,function(x){length(which(x>1.5))})
tapply(Edge_Traits$Tortuosity,Edge_Traits$name,function(x){length(which(x>1.5))/length(x)})
tapply(Edge_Traits$Tortuosity,Edge_Traits$name,function(x){length(which(x>1.5))})
tapply(Edge_Traits$Tortuosity,Edge_Traits$name,length)
```

```{r,echo = TRUE,message=FALSE,fig.height = 15, fig.width = 10}
Hist_Length_Tortuosity_4<-
Edge_Traits%>%
        filter(Tortuosity<1.5)%>%
        select(c("name","Species","Width","Length","Area","Volume","Resistance_2ave","Tortuosity","Distance",
                 "Accessibility","Betweenness","Route_factor","Or_ij"))%>%
        group_by(name)%>%
        gather(key=variable,
               value=value,Width:Or_ij)%>%
        
        filter(variable %in% c("Length","Tortuosity"))%>%#4_Tortuosity has little variation and depends on Length
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 2)+
        theme(legend.position = "none")
```

#### Visualizing the distribution of the data

Note: I am grouping the variables in different sets. Each set represents (to me) an intuitively logical set of related variables

```{r,fig.height = 15, fig.width = 10}
Hist_Width_Length_Distance_1
Hist_Width_Length_Area_Vol_2
Hist_Width_Length_Resistance_3
Hist_Length_Tortuosity_4
Hist_Resistance_Accessibility_Betweenness_5
Hist_Distance_Route_factor_6
```

Form these plots one learns that:

  1. Some variables are mathematically correlated:
  * Area= (pi/4)*Width^2
  * Volume= (pi/4)*(Width^2)*Length
  * Resitance= 10*Length/Width^2

  * Thus for subsequent analysis I will only use variables that are not (at least so easily) related to each other:
    * Width, Lenght, Tortuosity, Distance, Accessibility, Betweenness, Route Factor

  2. The distribution of the data for a  variable is similar across ose species. In summary:

  * Width: Varies from almost uniform to normal to bimodal to right skewed, and this depends on the species
  * Length: left skewed
  * Torturosity: "A bit" normal, still data is concentrated to the left. It is completely left skewed with tortuosity values higher than 1.5 are included which only represent less than 1% of the data
  * Distance: Normally distributed
  * Accessibility: A bit" normal, still data is concentrated to the left
  * Betwenness: Highly right skewed
  * Route Factor: A bit" normal, still data is concentrated to the left

What kind of transformations are needed for betweeness, Length (the ones that are clearly left-skewed) and Tortuosity


Betweenness can be log transformed (adding 1)
```{r,message=FALSE,fig.height = 15, fig.width = 10}
Edge_Traits%>%
        #filter(Tortuosity<1.5)%>%
        select(c("name","Species","Width","Length","Area","Volume","Resistance_2ave","Tortuosity","Distance",
                 "Accessibility","Betweenness","Route_factor","Or_ij"))%>%
        mutate(Log_Betweenness=log10(Betweenness+1))%>%
        group_by(name)%>%
        gather(key=variable,
               value=value,Width:Log_Betweenness)%>%
        
        filter(variable %in% c("Log_Betweenness","Distance"))%>%#4_Tortuosity has little variation and depends on Length
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 2)+
        theme(legend.position = "none")
```

Length can be log transformed and that makes it very normally ditributed
```{r,message=FALSE,fig.height = 15, fig.width = 10}
Edge_Traits%>%
        #filter(Tortuosity<1.5)%>%
        select(c("name","Species","Width","Length","Area","Volume","Resistance_2ave","Tortuosity","Distance",
                 "Accessibility","Betweenness","Route_factor","Or_ij"))%>%
        mutate(Log_Length=log10(Length))%>%
        group_by(name)%>%
        gather(key=variable,
               value=value,Width:Log_Length)%>%
        
        filter(variable %in% c("Log_Length","Distance"))%>%#4_Tortuosity has little variation and depends on Length
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 2)+
        theme(legend.position = "none")
```


### 2.3. Understanding relationships among variables. 

Before doing a correlogram of everything with everythin. Here I want to test specific relationships that I think 
might be interesting biologically

LENGTH AND WIDTH 
```{r,message=FALSE,echo=FALSE}
Log_Length_Width<-

#Length_Width<-
  Edge_Traits%>%
  ggplot()+
  aes(x=log10(Width),y=log10(Length),color=name)+
  #aes(x=Width,y=Length,color=name)+
  geom_point(alpha=0.8)+
  facet_wrap(. ~ Species, scales = "free",nrow = 6,ncol = 3)+
  theme(legend.position = "none")

Length_Width<-
  Edge_Traits%>%
  ggplot()+
  #aes(x=log10(Width),y=log10(Length),color=name)+
  aes(x=Width,y=Length,color=name)+
  geom_point(alpha=0.8)+
  facet_wrap(. ~ Species, scales = "free",nrow = 6,ncol = 3)+
  theme(legend.position = "none")
```

```{r,echo = TRUE,message=FALSE,fig.height = 15, fig.width = 10}
Length_Width
Log_Length_Width
```
The only thing I can tell from this one is that the thinnest hyphae have medium size length. Really long hyphae cannot be thin. There seems to be a lower boundary: the thinnest hypahe get longer up to a point where it is impossible to go thinniest and long. Note! Assuming this follows the two are connected by a power law

LENGTH; WIDTH AND DISTANCE
```{r,message=FALSE,warning=FALSE,echo=FALSE}
Log_Length_Distance<-
  Edge_Traits%>%
        ggplot()+
        aes(x=Distance,y=log10(Length),color=name)+
        geom_point(alpha=0.8)+
        facet_wrap(. ~ Species, scales = "free",nrow = 6,ncol = 3)+
        theme(legend.position = "none")

Distance_Lengt_Width<-
  Edge_Traits%>%
  filter(Area!=0)%>%
  ggplot()+
  aes(x=Distance,y=Length,color=Width)+
  #aes(Distance,Volume,color=Volume)+
  geom_point()+
  #geom_hex() +
  #geom_bin2d()+
  scale_color_continuous(type = "viridis")+
  #scale_fill_continuous(type = "viridis")+
  theme_bw()+
  facet_wrap(.~Species, scales = "free",nrow = 6,ncol = 3)

library(hexbin)

Distance_Volume<-
        Edge_Traits%>%
        filter(Area!=0)%>%
        ggplot()+
        aes(x=Distance,y=Volume)+
        #aes(Distance,Volume,color=Volume)+
        #geom_point()+
        geom_hex() +
        #geom_bin2d()+
        #scale_color_continuous(type = "viridis")+
        scale_fill_continuous(type = "viridis")+
        theme_bw()+
        facet_wrap(.~Species, scales = "free",nrow = 6,ncol = 3)
```

```{r,fig.height = 15, fig.width = 10}
Log_Length_Distance
```
Out of this one is clear that there is no relationship between length and distance

RESISTANCE WIDTH AND LENGTH (THIS IS MAINLY TO TEST THE MATHEMATICAL RELATIONSHIP AMONG THEM)
```{r echo=FALSE}
#Resistance_Width_Length<-
Log_Resistance_Width_Length<-
        Edge_Traits%>%
        ggplot()+
        #aes(x=Distance,y=Volume)+
        aes(x=log10(Length),y=log10(Resistance_2ave),color=log10(Width))+
        geom_point()+
        #geom_hex() +
        #geom_bin2d()+
        scale_color_continuous(type = "viridis")+
        #scale_fill_continuous(type = "viridis")+
        theme_bw()+
        facet_wrap(.~Species, scales = "free",nrow = 6,ncol = 3)

```

```{r,fig.height = 15, fig.width = 10}
Log_Resistance_Width_Length
```
This plot confirms the relationship between resistance and lenght and width

BETWEENNESS AND DISTANCE
```{r, echo=FALSE}
Log_Betweenness_Distance<-
        Edge_Traits%>%
        ggplot()+
        aes(y=log10(Betweenness+1),x=Distance)+
        #aes(Distance,Volume,color=Volume)+
        #geom_point()+
        geom_hex() +
        #geom_bin2d()+
        #scale_color_continuous(type = "viridis")+
        scale_fill_continuous(type = "viridis")+
        theme_bw()+
        facet_wrap(.~Species, scales = "free",nrow = 2,ncol = 3)
```

```{r,fig.height = 15, fig.width = 10}
Log_Betweenness_Distance
```


ROUTE FACTOR AND WIDTH
```{r, echo=FALSE}
RouteFactor_Width<-
  Edge_Traits%>%
  ggplot()+
  aes(y=Width,x=Route_factor,color=name)+
    geom_point()+
  #geom_hex() +
  #geom_bin2d()+
  geom_point(alpha=0.8,size=2)+
  facet_wrap(. ~ Species, scales = "free",nrow = 6,ncol = 3)+
  theme(legend.position = "none")
```

```{r,fig.height = 15, fig.width = 10}
RouteFactor_Width
```

Correlograms
```{r, message=FALSE,warning=FALSE}
library(GGally)

```

### Correlograms for each species
```{r,fig.height = 15, fig.width = 10}
Edge_Traits%>%
  filter(Species=="Mortierella elongata")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="Mortierella elongata",columns = 1:7,ggplot2::aes(color=Species))

Edge_Traits%>%
  filter(Species=="Umbelopsis isabellina")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="Umbelopsis isabellina",columns = 1:7,ggplot2::aes(color=Species))


Edge_Traits%>%
  filter(Species=="Mortierella alpina")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="Mortierella alpina",columns = 1:7,ggplot2::aes(color=Species))

Edge_Traits%>%
  filter(Species=="Mortierella elongata2")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="Mortierella elongata2",columns = 1:7,ggplot2::aes(color=Species))

Edge_Traits%>%
  filter(Species=="Mucor fragilis")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="Mucor fragilis",columns = 1:7,ggplot2::aes(color=Species))

Edge_Traits%>%
  filter(Species=="Mortierella alpina2")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="Mortierella alpina2",columns = 1:7,ggplot2::aes(color=Species))
```

#### Correlograms for all species together
```{r,fig.height = 15, fig.width = 10}
Edge_Traits%>%
  #filter(Species=="Mortierella elongata")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="All",columns = 1:7)
```

```{r,fig.height = 15, fig.width = 10, eval=FALSE, echo=FALSE}
Edge_Traits%>%
  #filter(Species=="Mortierella elongata")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="All",columns = 1:7,ggplot2::aes(color=Species))

```


# Visualizing and testing the clustering of species in trait space

```{r echo=FALSE, eval=FALSE}
#3. Performing a PCA on raw data and transformed data

Descriptive_traits<-
Edge_Traits%>%
  #filter(Species=="Mortierella elongata")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","name","Species"))

Model_descriptive_traits<-rda(Descriptive_traits[,c("Width","Log_Length","Tortuosity","Log_Betweenness")]~name+Condition(Species +Distance),scale = TRUE,data = Descriptive_traits)


Model_descriptive_traits
summary(Model_descriptive_traits)[["cont"]][["importance"]][,c(1:2)]
#                              RDA1         RDA2
# Eigenvalue            0.014666590 0.0029930041
# Proportion Explained  0.003739927 0.0007632051
# Cumulative Proportion 0.003739927 0.0045031321

anova.cca(Model_descriptive_traits,by="term")
# Permutation test for rda under reduced model
# Terms added sequentially (first to last)
# Permutation: free
# Number of permutations: 999
# 
# Model: rda(formula = Descriptive_traits[, c("Width", "Log_Length", "Tortuosity", "Log_Betweenness")] ~ name + Condition(Species + Distance), data = Descriptive_traits, scale = TRUE)
#              Df Variance      F Pr(>F)    
# name         10   0.0189 290.83  0.001 ***
# Residual 600416   3.9027                  
```


##### A model with information at the hyphal level showed to explain very little the variation, thus it is not worth using it. Thus a better option is to use mean values

```{r, echo=FALSE}
Descriptive_traits<-
Edge_Traits%>%
  #filter(Species=="Mortierella elongata")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","name","Species")) %>% 
  group_by(Species,name) %>% 
  summarise_at(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor"),mean) %>% ungroup()

Model_descriptive_traits<-rda(Descriptive_traits[,c("Width","Log_Length","Tortuosity","Log_Betweenness")]~Species+Condition(Distance),scale = TRUE,data = Descriptive_traits)

Model_descriptive_traits
#              Inertia Proportion Rank
# Total         4.00000    1.00000     
# Conditional   0.71843    0.17961    1
# Constrained   2.92904    0.73226    4
# Unconstrained 0.35253    0.08813    4
# Inertia is correlations 

summary(Model_descriptive_traits)[["cont"]][["importance"]][,c(1:2)]
#                            RDA1       RDA2
# Eigenvalue            2.6394842 0.27196022
# Proportion Explained  0.8043352 0.08287497
# Cumulative Proportion 0.8043352 0.88721012

anova.cca(Model_descriptive_traits,by="term")
#   Df Variance      F Pr(>F)    
# Species   5  2.92904 14.956  0.001 ***
# Residual  9  0.35253                  
plot(Model_descriptive_traits$Ybar[,1],Descriptive_traits$Width)
temporal<-as.data.frame(scores(Model_descriptive_traits,display = "sites",scaling = "sites",choices=c(1,2)))

Descriptive_traits<-cbind(Descriptive_traits,temporal);rm(temporal)

my_theme<-theme(
  title = element_text(size=25),
  axis.text.x = element_text(size=20),
  axis.text.y=element_text(size=20),
  strip.text.x=element_text(size=25),
  legend.position = "none")
```
#### Results from RDA

##### Proportion of data explained by constrained axes
```{r}
Model_descriptive_traits
```

#### Proportion of data explained by the first and second RDA axes
```{r, echo=FALSE}
summary(Model_descriptive_traits)[["cont"]][["importance"]][,c(1:2)]

```


#### Significance testing of the RDA (permutation based test of vegan package)
```{r, echo=FALSE}
anova.cca(Model_descriptive_traits,by="term")

```


### Clustering based on descriptive traits: "Width","Log_Length","Tortuosity","Log_Betweenness"
```{r}
Descriptive_traits %>% 
  ggplot()+
  aes(x=RDA1,y=RDA2,color=Species,label=Species) +
  geom_text() +
  scale_color_viridis_d()+
  labs(y="RDA2 8%",x="RDA1 80%")+
  my_theme
```


# Transport to tips traits

All relationships above consider each hyphal segment as separate replicate. This information is meaningful particularly for what I call the descriptive traits (width, lenght) but for the transport ones (accessibility)
this is a bit misleading as the transport from on hyphal segment to the next one is not going to change that much (or at all). Thus I am going to make a new analysis, this time only based on "Routes". That is the wholde
path from the center of the inoculum to an endpoint.


```{r, echo=FALSE}
#To do this one need to filter the hyphae of degree 1

Re_org_2<-
        Edge_Traits%>%
        #filter(Area!=0)%>%
        mutate(Route_Length=Distance*Route_factor)%>%
        select(c("name","Species","node_1_name_ID","EndNodes_1_Type","EndNodes_1_Degree","node_2_name_ID","EndNodes_2_Type","EndNodes_2_Degree",
                 "Distance","Accessibility","Betweenness","Route_factor","Route_Length"))%>%
        group_by(name)%>%
        gather(key=variable,
               value=value,Distance:Route_Length)
names(Edge_Traits)
```

#### Histograms of the transport traits: "Distance","Accessibility","Route_factor","Route_Length"
```{r,fig.height = 15, fig.width = 10}

        Re_org_2%>%
  filter(EndNodes_1_Degree==1|EndNodes_2_Degree==1)%>%
        filter(variable %in% c("Distance","Accessibility","Route_factor","Route_Length"))%>%#1_The completely indepedent variables
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 4)+
        theme(legend.position = "none")
```


#### Relationship among the transport traits
```{r}

Edge_Traits%>%
  mutate(Route_Length=Distance*Route_factor)%>%
  filter(EndNodes_1_Degree==1|EndNodes_2_Degree==1)%>%
  ggplot()+
  aes(y=Route_Length,x=Distance,color=name)+
    geom_point()+
  #geom_hex() +
  #geom_bin2d()+
  geom_point(alpha=0.8,size=2)+
  facet_wrap(. ~ Species, scales = "free",nrow = 6,ncol = 3)+
  theme(legend.position = "none")


Edge_Traits%>%
  mutate(Route_Length=Distance*Route_factor)%>%
  filter(EndNodes_1_Degree==1|EndNodes_2_Degree==1)%>%
  ggplot()+
  aes(x=Route_Length,y=Accessibility,color=name)+
    geom_point()+
  #geom_hex() +
  #geom_bin2d()+
  geom_point(alpha=0.8,size=2)+
  facet_wrap(. ~ Species, scales = "free",nrow = 6,ncol = 3)+
  theme(legend.position = "none")

```


#### Making correlograms for these transport traits
```{r,fig.height = 15, fig.width = 10}
Edge_Traits%>%
  mutate(Route_Length=Distance*Route_factor)%>%
  filter(EndNodes_1_Degree==1|EndNodes_2_Degree==1)%>%
  
  mutate(Species=as.factor(Species))%>%
  select(c("Distance","Accessibility","Route_factor","Route_Length","Species"))%>%
  ggpairs(title="All",columns = 1:4,ggplot2::aes(color=Species))

```

Comment from Mark: Betweenness values less than one are a proxy of links that are not particularly useful because that route is never being used


#### Clustering and testing the signficance of the clustering for these transport traits

```{r, echo=FALSE}

Transport_traits<-Edge_Traits%>%
  mutate(Route_Length=Distance*Route_factor)%>%
  filter(EndNodes_1_Degree==1|EndNodes_2_Degree==1) %>% 
  group_by(Species,name) %>% 
  summarise_at(c("Distance","Accessibility","Route_factor","Route_Length"),mean) %>% ungroup()


Model_transport_traits<-rda(Transport_traits[,c("Distance","Accessibility","Route_factor","Route_Length")]~Species,scale = TRUE,data = Transport_traits)
```

```{r}
Model_transport_traits
#               Inertia Proportion Rank
# Total            4.00       1.00     
# Constrained      2.76       0.69    4
# Unconstrained    1.24       0.31    4
# Inertia is correlations 
```


```{r}
summary(Model_transport_traits)[["cont"]][["importance"]][,c(1:2)]
#                       RDA1      RDA2
# Eigenvalue            1.6709939 0.8693697
# Proportion Explained  0.4177485 0.2173424
# Cumulative Proportion 0.4177485 0.6350909
```


```{r}

anova.cca(Model_transport_traits,by="term")
#          Df   Variance  F       Pr(>F)    
# Species   5   2.7598    4.4506  0.001 ***
# Residual 10   1.2402                  
#plot(Model_transport_traits$Ybar[,1],Transport_traits$Distance)

```


### Clustering based on transport traits (mean values per replicate)
```{r}

temporal<-as.data.frame(scores(Model_transport_traits,display = "sites",scaling = "sites",choices=c(1,2)))

Transport_traits<-cbind(Transport_traits,temporal);rm(temporal)

Transport_traits %>% 
  ggplot()+
  aes(x=RDA1,y=RDA2,color=Species,label=Species) +
  geom_text() +
  scale_color_viridis_d()+
  labs(y="RDA2 21%",x="RDA1 41%")+
  my_theme
```

# To do list:

Check how to deal with not anastomosis from the images... maybe removing the node degree higher or equal than 3... also check whether i can measure route factor in R

Other traits to include is the total length of the mycelium, and the total lenght divided by the number of hyphal segments

Revise again how do I know that the traits are not not adjusted to micrometers but pixels

Is mean length the same as the total length of the mycelium divided by the number of hyphae

Check again what is Ybar from the output of vegan

Check whether I got new data on the problmatic species including umpellopsis

Maybe the twist here is how to tell appart phenotypically species that are closely related to each other. I should ask Anika what is the evidence for the mucoromycota species to behave differently.

Think how to treat betweenness

Check in igraph how to identify particular routes in a network

Think how to deal with the relationship between accessibility and resistance and route factor

```{r}
#To calcuate the second peak of the bimodal distribution
find_modes<- function(x) {
  modes <- NULL
  for ( i in 2:(length(x)-1) ){
    if ( (x[i] > x[i-1]) & (x[i] > x[i+1]) ) {
      modes <- c(modes,i)
    }
  }
  if ( length(modes) == 0 ) {
    modes = 'This is a monotonic distribution'
  }
  return(modes)
}

trial<-Edge_Traits$Width[Edge_Traits$name=="C35(4)_t30"]



my_mode_indices<-
find_modes(density(trial)$y)


density(trial)$y[my_mode_indices]
density(trial)$x[my_mode_indices]
#0.9040683 5.5380611
density(trial)$x[which(density(trial)$y==max(density(trial)$y))]


#For all of them:
modes<-function(x){
names(table(x))[table(x)==max(table(x))]}


tapply(Edge_Traits$Width, Edge_Traits$name, function(f) {density(f)$x[find_modes(density(f)$y)]})
tapply(Edge_Traits$Width, Edge_Traits$name,)



library(diptest)
plot(density(Edge_Traits$Width[Edge_Traits$name=="C35(4)_t30"]))
dip(Edge_Traits$Width[Edge_Traits$name=="C35(4)_t30"], full.result = T)
dip.test(Edge_Traits$Width[Edge_Traits$name=="C35(4)_t30"])



dip(trial,full.result = "all")
plot(dip(trial,full.result = "all"))



data("statfaculty")
plot(density(statfaculty))
plot(dip(statfaculty,full.result = "all"))

#this package provides a metric of distances between the two means. However I do not really like it.
library(BimodalIndex)
library(oompaData)
data(lungData)
bimodalIndex(lung.dataset,verbose = F)
t(head(
Edge_Traits[Edge_Traits$name=="C35(4)_t30",c("Width","Length")]))
bimodalIndex(t(Edge_Traits[Edge_Traits$name=="C35(4)_t30",c("Width")]))

#The package "multimode" might also be useful

Re_org%>%
        filter(variable %in% c("Width")) %>% #,"Length","Distance"))%>%#1_The completely indepedent variables
        filter(name=="C35(4)_t30") %>% 
        ggplot()+
        aes(value,fill=name)+
        #geom_histogram(binwidth = 0.5)+
        geom_density()+
        #facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 3)+
        theme(legend.position = "none")
```

# As a conclussion I will use the Dip statistic to describe how "strong" is the bimodality for width, which would mean how distinct are the major roads from all other road types.

For the multivariate analysis I should not use the mean for the width, but better the two modes, particularly the first peak which is the esiest to identify. For length I will use the log of the mean, for tortuosity as well, and for betweenness..

# Understanding betweeness

The betwenness of edges (k=1) is not the same as the total number of edges
```{r}
tapply(Edge_Traits$name,Edge_Traits$name,length)

with(
  Edge_Traits[which(Edge_Traits$EndNodes_1_Degree==1|Edge_Traits$EndNodes_2_Degree==1),],
tapply(Betweenness,name,unique)
)
```

But these two values are proportional to each other
```{r}
plot(
tapply(Edge_Traits$name,Edge_Traits$name,length),
with(
  Edge_Traits[which(Edge_Traits$EndNodes_1_Degree==1|Edge_Traits$EndNodes_2_Degree==1),],
tapply(Betweenness,name,unique)
)
)
```

The edges maximum betweenness for each colony are located always close to the center of the colony
```{r}
tapply(Edge_Traits$Distance,Edge_Traits$name,min)
```


```{r}

sapply(
  split(Edge_Traits,Edge_Traits$name),function(x){
    unique(x$Distance[x$Betweenness==max(x$Betweenness)])
  }
  
)

tapply(Edge_Traits$Betweenness,Edge_Traits$name,max)
```

But they are not the minimal values, they lay though within 2 times the minimum distance
```{r}
sapply(
  split(Edge_Traits,Edge_Traits$name),function(x){
    summary(x$Betweenness[x$Distance<=2*min(x$Distance)])
  }
  
)
```

It makes sense for the maximum betweenness to lay close to the center of the colony as it is where most of the "root" edges are




The minimum betweenness value is 0 and it occurs in all colonies. Thus the question is, what do edges with betwenness 0 have in common?

a) They are not tips. All of them have a degree larger or equal to two
```{r}
with(
  Edge_Traits[which(Edge_Traits$Betweenness==0),],
tapply(EndNodes_2_Degree,name,summary)
)
```

b) They represent between the 6% to 14% of all edges
```{r}
with(
  Edge_Traits[which(Edge_Traits$Betweenness==0),],
tapply(name,name,length)
)/tapply(Edge_Traits$name,Edge_Traits$name,length)

```

```{r}
tapply(Edge_Traits$Distance,Edge_Traits$name,min)
```



```{r}
sapply(
  split(Edge_Traits,Edge_Traits$name),function(x){
    summary(x$Distance[x$Betweenness<=min(x$Betweenness)+10])
  }
  
)
```



```{r}

temporal<-Edge_Traits[which(Edge_Traits$Betweenness==
min(Edge_Traits$Betweenness)),]

Edge_Traits %>% 
filter(Species=="Mortierella elongata") %>% 
  filter(Betweenness<21729)%>%
  ggplot()+
  aes(Betweenness)+
  geom_histogram()+
  facet_wrap(.~name)


Edge_Traits%>%
#        filter(EndNodes_1_Degree==1|EndNodes_2_Degree==1)%>%
  filter(Species=="Mortierella elongata") %>% 
  filter(Betweenness>21729)%>%
  
        select(c("name","Species","Width","Length","Area","Volume","Resistance_2ave","Tortuosity","Distance",
                 "Accessibility","Betweenness","Route_factor","Or_ij"))%>%
        mutate(Log_Betweenness=log10(Betweenness+1))%>%
        group_by(name)%>%
        gather(key=variable,
            value=value,Width:Log_Betweenness)%>%
        
        filter(variable %in% c("Betweenness"))%>%#4_Tortuosity has little variation and depends on Length
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
  facet_wrap(name ~ variable, scales = "free",nrow = 3,ncol = 3)#+
        #facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 2)#+
        #theme(legend.position = "none")


```


