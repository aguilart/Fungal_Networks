---
title: "Multivariate analysis"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})

author: "Carlos"
date: "02/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Multivariate Analysis of Network data

Note: This tutorial is bascially the same as the on described in "Protocol_multivariate.R". Either download the repo or, much easier, just copy the script and paste into your r script.

## Intro & Basics

The question addressed here is whether network traits "cluster" according to species identity
For this we are using:

  * PCA: To visualize whether there is any clustering
  * Difference in the correlations among variables per species
  * PERMANOVA: to test difference among groups

To do that I use base R functions combined with functions from three other packages: vegan, tidyverse and RColorBrewer
You might need to install those packages. You can do that via R studio or: 

```{r, eval=FALSE}
#install.packages("vegan")
#install.packages("tidyverse")
#install.packages("RColorBrewer")

#Comment in if needed!

```

## 1. Loading files.

Note: one can load directly excel files (.xlxs) using R studio. This is a relatively new
feature. I am used to the function "read.csv" for which I need to save the excel sheet I am interested as
a csv file first. In this case, I saved the "edge" sheet of each excel file of each of the 6 species as .csv

# First Edge files

```{r }
#These lines will load all files saved as .csv in the folder "processedData" and then merging them ("row bind")
temp = list.files(path="processedData\\",pattern="*-Edge.csv")
temp<-paste("processedData\\",temp,sep = "")
myfiles = lapply(temp,function(x){read.csv(x,header = TRUE,stringsAsFactors = FALSE)} )
#myfiles[[4]]<-myfiles[[4]][,c(1:42)]
Edge_Traits<-do.call(rbind,myfiles)

Edge_Traits$Species<-NA
Edge_Traits$Species[grep("C34",Edge_Traits$name)]<-"Mortierella elongata"
Edge_Traits$Species[grep("C35",Edge_Traits$name)]<-"Umbelopsis isabellina"
Edge_Traits$Species[grep("DF19",Edge_Traits$name)]<-"Mortierella alpina"
Edge_Traits$Species[grep("DF25",Edge_Traits$name)]<-"Mortierella elongata2"
Edge_Traits$Species[grep("DF56",Edge_Traits$name)]<-"Mucor fragilis"
Edge_Traits$Species[grep("M",Edge_Traits$name)]<-"Mortierella alpina2"

#Assuming the Or_ij can be expressed from 0 to 360 degrees
Edge_Traits$Or_ij[which(Edge_Traits$Or_ij<0)]<-(Edge_Traits$Or_ij[which(Edge_Traits$Or_ij<0)]*-1)+180

Edge_Traits<-Edge_Traits[which(Edge_Traits$Type=="E"),]

#I am removing seven values with Width=0
Edge_Traits<-Edge_Traits[-which(Edge_Traits$Width==0),]

```


## 2. Getting to know the data.

### 2.1 How R sees the data. 
It is useful to have an idea on how R recognize the data. R is an "object oriented"
program language. That is, every data is an object which has certain properties. R uses these properties to 
categorized the object. It is useful to know what kind of object is your data because some functions only work
on one object type but not in others.


```{r}
str(Edge_Traits)
```

### 2.2. Understanding the variables and their distribution. 
More impotantly, what is the distribution of the data? 
To simply get means, min, max per fungal species per variable:

```{r}
aggregate(
        Edge_Traits[,
                         c("Width","Length","Area","Volume","Resistance_2ave","Tortuosity","Distance",
                           "Accessibility","Betweenness","Route_factor","Or_ij")],
        by=list(Edge_Traits[which(Edge_Traits$Type=="E"),]$name),
        mean)#Here you  can write different functions: min, max, median. range and summmary is also good because it
                #gets you more than one summary statistics, but it can be confusing with so much data.
```

```{r,message=FALSE,warning=FALSE}
library(tidyverse)
```

I had some issues understanding what Resistance is. Playing with the following code allowed me to determine that 
 Resistance_2ave = 10*(Length)/width^2
```{r,eval=FALSE}
summary(Edge_Traits$Resistance_2ave)
length(which(Edge_Traits$Width_intact==0))
Edge_Traits%>%
        #filter(Area!=0)%>%
        #filter(Resistance_2ave>500)%>%
        mutate(MyResistance=Length/(Width/2)^2)%>%
        mutate(Factor=Resistance_2ave/MyResistance)%>%
        select(Species,name,Length,Width,Resistance_2ave)%>%
        ggplot()+
        aes(y=Resistance_2ave,x=name,fill=name)+
        geom_boxplot()+
        facet_grid(. ~ Species, scales = "free")+
        theme(legend.position = "none")
  

length(which(Edge_Traits$Resistance_2ave>500))
```

Visualinzing as simple historgrams helps. To make those, I use the suite of functions in the package tidyverse.


First, reorganizing the dataframe helps so the figures are made easier

```{r}
Re_org<-
        Edge_Traits%>%
        #filter(Area!=0)%>%
        #mutate(MyResistance=Length/(Width/2)^2)%>%
        select(c("name","Species","Width","Length","Area","Volume","Resistance_2ave","Tortuosity","Distance",
                 "Accessibility","Betweenness","Route_factor","Or_ij"))%>%
        group_by(name)%>%
        gather(key=variable,
               value=value,Width:Or_ij)
```        
        

Now we can make simple histograms 

Note: I am grouping the variables in different sets. Each set represents (to me) an intuitively logical set of related variables

```{r,echo = TRUE,message=FALSE}
Hist_Width_Length_Distance_1<-
        Re_org%>%
        filter(variable %in% c("Width","Length","Distance"))%>%#1_The completely indepedent variables
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 3)+
        theme(legend.position = "none")
  
Hist_Width_Length_Area_Vol_2<-
          Re_org%>%
        
        filter(variable %in% c("Width","Length","Area","Volume"))%>%#2_The geometric ones depending on width and length
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 4)+
        theme(legend.position = "none")

Hist_Width_Length_Resistance_3<-
          Re_org%>%
        
        filter(variable %in% c("Width","Length","Resistance_2ave"))%>%#3_The "transport" one depending on width and length
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 3)+
        theme(legend.position = "none")

#Hist_Length_Tortuosity_4<-For this one see below

Hist_Resistance_Accessibility_Betweenness_5<-
          Re_org%>%
        
        filter(variable %in% c("Resistance_2ave","Accessibility","Betweenness"))%>%#5_The "transport" ones depending all on Resistance to some extent
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 3)+
        theme(legend.position = "none")

Hist_Distance_Route_factor_6<-
        
        Re_org%>%
        
        filter(variable %in% c("Route_factor","Distance"))%>%#6_The only that depends on distance
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 2)+
        theme(legend.position = "none")
```

About tortuosity

```{r,echo = TRUE,message=FALSE,eval=FALSE}
tapply(Edge_Traits$Tortuosity,Edge_Traits$name,summary)
tapply(Edge_Traits$Tortuosity,Edge_Traits$name,function(x){length(which(x>1.5))})
tapply(Edge_Traits$Tortuosity,Edge_Traits$name,function(x){length(which(x>1.5))/length(x)})
tapply(Edge_Traits$Tortuosity,Edge_Traits$name,function(x){length(which(x>1.5))})
tapply(Edge_Traits$Tortuosity,Edge_Traits$name,length)
```

```{r,echo = TRUE,message=FALSE,fig.height = 15, fig.width = 10}
Hist_Length_Tortuosity_4<-
Edge_Traits%>%
        filter(Tortuosity<1.5)%>%
        select(c("name","Species","Width","Length","Area","Volume","Resistance_2ave","Tortuosity","Distance",
                 "Accessibility","Betweenness","Route_factor","Or_ij"))%>%
        group_by(name)%>%
        gather(key=variable,
               value=value,Width:Or_ij)%>%
        
        filter(variable %in% c("Length","Tortuosity"))%>%#4_Tortuosity has little variation and depends on Length
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 2)+
        theme(legend.position = "none")
```
Looking at the plots

Note: Here the display is not optimal. When you execute this code in your computer it looks much better
```{r,fig.height = 15, fig.width = 10}
Hist_Width_Length_Distance_1
Hist_Width_Length_Area_Vol_2
Hist_Width_Length_Resistance_3
Hist_Length_Tortuosity_4
Hist_Resistance_Accessibility_Betweenness_5
Hist_Distance_Route_factor_6
```

Form these plots one learns that:

  1. Some variables are mathematically correlated:
  * Area= (pi/4)*Width^2
  * Volume= (pi/4)*(Width^2)*Length
  * Resitance= 10*Length/Width^2

  * Thus for subsequent analysis I will only use variables that are not (at least so easily) related to each other:
    * Width, Lenght, Tortuosity, Distance, Accessibility, Betweenness, Route Factor

  2. The distribution of the data for a  variable is similar across ose species. In summary:

  * Width: Varies from almost uniform to normal to bimodal to right skewed, and this depends on the species
  * Length: left skewed
  * Torturosity: "A bit" normal, still data is concentrated to the left. It is completely left skewed with tortuosity values higher than 1.5 are included which only represent less than 1% of the data
  * Distance: Normally distributed
  * Accessibility: A bit" normal, still data is concentrated to the left
  * Betwenness: Highly right skewed
  * Route Factor: A bit" normal, still data is concentrated to the left

What kind of transformations are needed for betweeness, Length (the ones that are clearly left-skewed) and Tortuosity


Betweenness can be log transformed (adding 1)
```{r,message=FALSE,fig.height = 15, fig.width = 10}
Edge_Traits%>%
        #filter(Tortuosity<1.5)%>%
        select(c("name","Species","Width","Length","Area","Volume","Resistance_2ave","Tortuosity","Distance",
                 "Accessibility","Betweenness","Route_factor","Or_ij"))%>%
        mutate(Log_Betweenness=log10(Betweenness+1))%>%
        group_by(name)%>%
        gather(key=variable,
               value=value,Width:Log_Betweenness)%>%
        
        filter(variable %in% c("Log_Betweenness","Distance"))%>%#4_Tortuosity has little variation and depends on Length
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 2)+
        theme(legend.position = "none")
```

Length can be log transformed and that makes it very normally ditributed
```{r,message=FALSE,fig.height = 15, fig.width = 10}
Edge_Traits%>%
        #filter(Tortuosity<1.5)%>%
        select(c("name","Species","Width","Length","Area","Volume","Resistance_2ave","Tortuosity","Distance",
                 "Accessibility","Betweenness","Route_factor","Or_ij"))%>%
        mutate(Log_Length=log10(Length))%>%
        group_by(name)%>%
        gather(key=variable,
               value=value,Width:Log_Length)%>%
        
        filter(variable %in% c("Log_Length","Distance"))%>%#4_Tortuosity has little variation and depends on Length
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 2)+
        theme(legend.position = "none")
```


### 2.3. Understanding relationships among variables. 

Before doing a correlogram of everything with everythin. Here I want to test specific relationships that I think 
might be interesting biologically

LENGTH AND WIDTH 
```{r,message=FALSE}
Log_Length_Width<-

#Length_Width<-
  Edge_Traits%>%
  ggplot()+
  aes(x=log10(Width),y=log10(Length),color=name)+
  #aes(x=Width,y=Length,color=name)+
  geom_point(alpha=0.8)+
  facet_wrap(. ~ Species, scales = "free",nrow = 6,ncol = 3)+
  theme(legend.position = "none")

Length_Width<-
  Edge_Traits%>%
  ggplot()+
  #aes(x=log10(Width),y=log10(Length),color=name)+
  aes(x=Width,y=Length,color=name)+
  geom_point(alpha=0.8)+
  facet_wrap(. ~ Species, scales = "free",nrow = 6,ncol = 3)+
  theme(legend.position = "none")
```

```{r,echo = TRUE,message=FALSE,fig.height = 15, fig.width = 10}
Length_Width
Log_Length_Width
```
The only think I can tell from this one is that the thinnest hyphae have medium size length. Really long hyphae cannot be thin. There seems to be a lower boundary: the thinnest hypahe get longer up to a point where it is impossible to go thinniest and long. Note! Assuming this follows the two are connected by a power law

LENGTH; WIDTH AND DISTANCE
```{r,message=FALSE,warning=FALSE}
Log_Length_Distance<-
  Edge_Traits%>%
        ggplot()+
        aes(x=Distance,y=log10(Length),color=name)+
        geom_point(alpha=0.8)+
        facet_wrap(. ~ Species, scales = "free",nrow = 6,ncol = 3)+
        theme(legend.position = "none")

Distance_Lengt_Width<-
  Edge_Traits%>%
  filter(Area!=0)%>%
  ggplot()+
  aes(x=Distance,y=Length,color=Width)+
  #aes(Distance,Volume,color=Volume)+
  geom_point()+
  #geom_hex() +
  #geom_bin2d()+
  scale_color_continuous(type = "viridis")+
  #scale_fill_continuous(type = "viridis")+
  theme_bw()+
  facet_wrap(.~Species, scales = "free",nrow = 6,ncol = 3)

library(hexbin)

Distance_Volume<-
        Edge_Traits%>%
        filter(Area!=0)%>%
        ggplot()+
        aes(x=Distance,y=Volume)+
        #aes(Distance,Volume,color=Volume)+
        #geom_point()+
        geom_hex() +
        #geom_bin2d()+
        #scale_color_continuous(type = "viridis")+
        scale_fill_continuous(type = "viridis")+
        theme_bw()+
        facet_wrap(.~Species, scales = "free",nrow = 6,ncol = 3)
```

```{r,fig.height = 15, fig.width = 10}
Log_Length_Distance
```
Out of this one is clear that there is no relationship between length and distance

RESISTANCE WIDTH AND LENGTH (THIS IS MAINLY TO TEST THE MATHEMATICAL RELATIONSHIP AMONG THEM)
```{r}
#Resistance_Width_Length<-
Log_Resistance_Width_Length<-
        Edge_Traits%>%
        ggplot()+
        #aes(x=Distance,y=Volume)+
        aes(x=log10(Length),y=log10(Resistance_2ave),color=log10(Width))+
        geom_point()+
        #geom_hex() +
        #geom_bin2d()+
        scale_color_continuous(type = "viridis")+
        #scale_fill_continuous(type = "viridis")+
        theme_bw()+
        facet_wrap(.~Species, scales = "free",nrow = 6,ncol = 3)

```

```{r,fig.height = 15, fig.width = 10}
Log_Resistance_Width_Length
```
This plot confirms the relationship between resistance and lenght and width

BETWEENNESS AND DISTANCE
```{r}
Log_Betweenness_Distance<-
        Edge_Traits%>%
        ggplot()+
        aes(y=log10(Betweenness+1),x=Distance)+
        #aes(Distance,Volume,color=Volume)+
        #geom_point()+
        geom_hex() +
        #geom_bin2d()+
        #scale_color_continuous(type = "viridis")+
        scale_fill_continuous(type = "viridis")+
        theme_bw()+
        facet_wrap(.~Species, scales = "free",nrow = 2,ncol = 3)
```

```{r,fig.height = 15, fig.width = 10}
Log_Betweenness_Distance
```


ROUTE FACTOR AND WIDTH
```{r}
RouteFactor_Width<-
  Edge_Traits%>%
  ggplot()+
  aes(y=Width,x=Route_factor,color=name)+
    geom_point()+
  #geom_hex() +
  #geom_bin2d()+
  geom_point(alpha=0.8,size=2)+
  facet_wrap(. ~ Species, scales = "free",nrow = 6,ncol = 3)+
  theme(legend.position = "none")
```

```{r,fig.height = 15, fig.width = 10}
RouteFactor_Width
```

Correlograms
```{r, message=FALSE,warning=FALSE}
library(GGally)

```

```{r,fig.height = 15, fig.width = 10}
Edge_Traits%>%
  filter(Species=="Mortierella elongata")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="Mortierella elongata",columns = 1:7,ggplot2::aes(color=Species))

Edge_Traits%>%
  filter(Species=="Umbelopsis isabellina")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="Umbelopsis isabellina",columns = 1:7,ggplot2::aes(color=Species))


Edge_Traits%>%
  filter(Species=="Mortierella alpina")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="Mortierella alpina",columns = 1:7,ggplot2::aes(color=Species))

Edge_Traits%>%
  filter(Species=="Mortierella elongata2")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="Mortierella elongata2",columns = 1:7,ggplot2::aes(color=Species))

Edge_Traits%>%
  filter(Species=="Mucor fragilis")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="Mucor fragilis",columns = 1:7,ggplot2::aes(color=Species))

Edge_Traits%>%
  filter(Species=="Mortierella alpina2")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="Mortierella alpina2",columns = 1:7,ggplot2::aes(color=Species))
```

```{r,fig.height = 15, fig.width = 10}
Edge_Traits%>%
  #filter(Species=="Mortierella elongata")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="All",columns = 1:7)
```

```{r,fig.height = 15, fig.width = 10}
Edge_Traits%>%
  #filter(Species=="Mortierella elongata")%>%
  filter(Tortuosity<1.5)%>%
        
  mutate(Log_Betweenness=log10(Betweenness+1))%>%
  mutate(Log_Length=log10(Length))%>%
  mutate(Species=as.factor(Species))%>%
  select(c("Width","Log_Length","Tortuosity","Distance",
                 "Accessibility","Log_Betweenness","Route_factor","Species"))%>%
  ggpairs(title="All",columns = 1:7,ggplot2::aes(color=Species))

```


