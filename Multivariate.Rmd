---
title: "Multivariate analysis"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})

author: "Carlos"
date: "02/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Multivariate Analysis of Network data

Note: This tutorial is bascially the same as the on described in "Protocol_multivariate.R". Either download the repo or, much easier, just copy the script and paste into your r script.

## Intro & Basics

The question addressed here is whether network traits "cluster" according to species identity
For this we are using:

  * PCA: To visualize whether there is any clustering
  * Difference in the correlations among variables per species
  * PERMANOVA: to test difference among groups

To do that I use base R functions combined with functions from three other packages: vegan, tidyverse and RColorBrewer
You might need to install those packages. You can do that via R studio or: 

```{r, eval=FALSE}
#install.packages("vegan")
#install.packages("tidyverse")
#install.packages("RColorBrewer")

#Comment in if needed!

```

## 1. Loading files.

Note: one can load directly excel files (.xlxs) using R studio. This is a relatively new
feature. I am used to the function "read.csv" for which I need to save the excel sheet I am interested as
a csv file first. In this case, I saved the "edge" sheet of each excel file of each of the 6 species as .csv

# First Edge files

```{r }
#These lines will load all files saved as .csv in the folder "processedData" and then merging them ("row bind")
temp = list.files(path="processedData\\",pattern="*-Edge.csv")
temp<-paste("processedData\\",temp,sep = "")
myfiles = lapply(temp,function(x){read.csv(x,header = TRUE,stringsAsFactors = FALSE)} )
#myfiles[[4]]<-myfiles[[4]][,c(1:42)]
Edge_Traits<-do.call(rbind,myfiles)

Edge_Traits$Species<-NA
Edge_Traits$Species[grep("C34",Edge_Traits$name)]<-"Mortierella elongata"
Edge_Traits$Species[grep("C35",Edge_Traits$name)]<-"Umbelopsis isabellina"
Edge_Traits$Species[grep("DF19",Edge_Traits$name)]<-"Mortierella alpina"
Edge_Traits$Species[grep("DF25",Edge_Traits$name)]<-"Mortierella elongata2"
Edge_Traits$Species[grep("DF56",Edge_Traits$name)]<-"Mucor fragilis"
Edge_Traits$Species[grep("M",Edge_Traits$name)]<-"Mortierella alpina2"

#Assuming the Or_ij can be expressed from 0 to 360 degrees
Edge_Traits$Or_ij[which(Edge_Traits$Or_ij<0)]<-(Edge_Traits$Or_ij[which(Edge_Traits$Or_ij<0)]*-1)+180

Edge_Traits<-Edge_Traits[which(Edge_Traits$Type=="E"),]

#I am removing seven values with Width=0
Edge_Traits<-Edge_Traits[-which(Edge_Traits$Width==0),]

```


## 2. Getting to know the data.

### 2.1 How R sees the data. 
It is useful to have an idea on how R recognize the data. R is an "object oriented"
program language. That is, every data is an object which has certain properties. R uses these properties to 
categorized the object. It is useful to know what kind of object is your data because some functions only work
on one object type but not in others.


```{r}
str(Edge_Traits)
```

### 2.2. Understanding the variables and their distribution. 
More impotantly, what is the distribution of the data? 
To simply get means, min, max per fungal species per variable:

```{r}
aggregate(
        Edge_Traits[,
                         c("Width","Length","Area","Volume","Resistance_2ave","Tortuosity","Distance",
                           "Accessibility","Betweenness","Route_factor","Or_ij")],
        by=list(Edge_Traits[which(Edge_Traits$Type=="E"),]$name),
        mean)#Here you  can write different functions: min, max, median. range and summmary is also good because it
                #gets you more than one summary statistics, but it can be confusing with so much data.
```

I had some issues understanding what Resistance is. Playing with the following code allowed me to determine that 
 Resistance_2ave is the 10*(Length)/width^2
```{r,message=FALSE}
library(tidyverse)
```

```{r}
summary(Edge_Traits$Resistance_2ave)
length(which(Edge_Traits$Width_intact==0))
Edge_Traits%>%
        #filter(Area!=0)%>%
        #filter(Resistance_2ave>500)%>%
        mutate(MyResistance=Length/(Width/2)^2)%>%
        mutate(Factor=Resistance_2ave/MyResistance)%>%
        select(name,Length,Width,Resistance_2ave)%>%
        ggplot()+
        aes(Species,Resistance_2ave)+
        geom_boxplot()

length(which(Edge_Traits$Resistance_2ave>500))
```

```{r}
Edge_Traits_c<-Edge_Traits

Edge_Traits<-do.call(rbind,
lapply(
split(Edge_Traits,Edge_Traits$name),head))
```

Visualinzing as simple historgrams helps. To make those, I use the suite of functions in the package tidyverse.


First, reorganizing the dataframe helps so the figures are made easier

```{r}
Re_org<-
        Edge_Traits%>%
        #filter(Area!=0)%>%
        #mutate(MyResistance=Length/(Width/2)^2)%>%
        select(c("name","Species","Width","Length","Area","Volume","Resistance_2ave","Tortuosity","Distance",
                 "Accessibility","Betweenness","Route_factor","Or_ij"))%>%
        group_by(name)%>%
        gather(key=variable,
               value=value,Width:Or_ij)
```        
        

Now we can make simple histograms 

Note: I am grouping the variables in different sets. Each set represents (to me) an intuitively logical set of related variables

```{r,echo = FALSE,message=FALSE}
Hist_Width_Length_Distance_1<-
        Re_org%>%
        filter(variable %in% c("Width","Length","Distance"))%>%#1_The completely indepedent variables
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 3)+
        theme(legend.position = "none")
  
Hist_Width_Length_Area_Vol_2<-
          Re_org%>%
        
        filter(variable %in% c("Width","Length","Area","Volume"))%>%#2_The geometric ones depending on width and length
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 4)+
        theme(legend.position = "none")

Hist_Width_Length_Resistance_3<-
          Re_org%>%
        
        filter(variable %in% c("Width","Length","Resistance_2ave"))%>%#3_The "transport" one depending on width and length
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 3)+
        theme(legend.position = "none")

#Hist_Length_Tortuosity_4<-For this one see below

Hist_Resistance_Accessibility_Betweenness_5<-
          Re_org%>%
        
        filter(variable %in% c("Resistance_2ave","Accessibility","Betweenness"))%>%#5_The "transport" ones depending all on Resistance to some extent
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 3)+
        theme(legend.position = "none")

Hist_Distance_Route_factor_6<-
        
        Re_org%>%
        
        filter(variable %in% c("Route_factor","Distance"))%>%#6_The only that depends on distance
        
        ggplot()+
        aes(value,fill=name)+
        geom_histogram()+
        facet_wrap(Species ~ variable, scales = "free",nrow = 6,ncol = 2)+
        theme(legend.position = "none")
```


Looking at the plots
```{r}
Hist_Width_Length_Distance_1
Hist_Width_Length_Area_Vol_2
Hist_Width_Length_Resistance_3
Hist_Resistance_Accessibility_Betweenness_5
Hist_Distance_Route_factor_6
```

